const express = require("express");
const session = require("express-session");
const { MongoClient } = require("mongodb");
const path = require("path");

const app = express();
const PORT = 3000;
// ------- Destinations list for search -------
const destinations = [
  { name: "Paris", category: "City", url: "/paris" },
  { name: "Rome", category: "City", url: "/rome" },
  { name: "Bali", category: "Island", url: "/bali" },
  { name: "Santorini", category: "Island", url: "/santorini" },
  { name: "Annapurna", category: "Hiking", url: "/annapurna" },
  { name: "Inca Trail", category: "Hiking", url: "/inca" },
];


// --------- MongoDB setup ---------
const url = "mongodb://localhost:27017";
const dbName = "myDB";
const collectionName = "myCollection";

let db;
let usersCollection;

MongoClient.connect(url)
  .then((client) => {
    console.log("Connected to MongoDB");
    db = client.db(dbName);
    usersCollection = db.collection(collectionName);
  })
  .catch((error) => console.error("MongoDB connection error:", error));

// --------- Middleware ---------
app.use(express.urlencoded({ extended: true }));
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

app.use(
  session({
    secret: "travelling-website-secret-key",
    resave: false,
    saveUninitialized: false,
    cookie: { secure: false }, // OK for localhost
  })
);

// view engine
app.set("view engine", "ejs");
app.set("views", path.join(__dirname, "views")); // folder name MUST be "views"

// --------- Auth helper ---------
function requireLogin(req, res, next) {
  if (!req.session.username) {
    return res.redirect("/login");
  }
  next();
}

// --------- ROUTES ---------

// root â†’ login
app.get("/", (req, res) => {
  res.redirect("/login");
});

// --------- Registration ---------

// both URLs show the same page
app.get("/register", (req, res) => {
  res.render("registration", { error: null, success: null });
});

app.get("/registration", (req, res) => {
  res.render("registration", { error: null, success: null });
});

// form submits to /register (POST)
app.post("/register", async (req, res) => {
  try {
    const { username, password } = req.body;

    if (!username || !password || username.trim() === "" || password.trim() === "") {
      return res.render("registration", {
        error: "Username and password cannot be empty",
        success: null,
      });
    }

    const existingUser = await usersCollection.findOne({ username });

    if (existingUser) {
      return res.render("registration", {
        error: "Username already in DB",
        success: null,
      });
    }

    await usersCollection.insertOne({
      username,
      password,
      wantToGoList: [],
    });

    console.log("User registered successfully:", username);
    res.redirect("/login?registered=true");
  } catch (err) {
    console.error("Registration error:", err);
    res.render("registration", {
      error: "An error occurred. Please try again.",
      success: null,
    });
  }
});


// --------- TEMP Login + Home (can be replaced by friends later) ---------
app.get("/login", (req, res) => {
  res.render("login", { error: null });
});

app.post("/login", async (req, res) => {
  const { username, password } = req.body;

  const user = await usersCollection.findOne({ username, password });

  if (!user) {
    return res.render("login", { error: "Invalid username or password" });
  }

  req.session.username = username;
  res.redirect("/home");
});

app.get("/home", requireLogin, (req, res) => {
  res.render("home", { username: req.session.username });
});

// --------- CATEGORY PAGES (your part) ---------
app.get("/hiking", requireLogin, (req, res) => {
  res.render("hiking");
});

app.get("/cities", requireLogin, (req, res) => {
  res.render("cities");
});

app.get("/islands", requireLogin, (req, res) => {
  res.render("islands");
});

// --------- DESTINATION PAGES ---------
app.get("/annapurna", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const alreadyInList = user.wantToGoList.includes("Annapurna");
    res.render("annapurna", { alreadyInList, message: req.query.message || null });
  } catch (err) {
    console.error("Error:", err);
    res.render("annapurna", { alreadyInList: false, message: null });
  }
});

app.get("/inca", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const alreadyInList = user.wantToGoList.includes("Inca Trail");
    res.render("inca", { alreadyInList, message: req.query.message || null });
  } catch (err) {
    console.error("Error:", err);
    res.render("inca", { alreadyInList: false, message: null });
  }
});

app.get("/paris", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const alreadyInList = user.wantToGoList.includes("Paris");
    res.render("paris", { alreadyInList, message: req.query.message || null });
  } catch (err) {
    console.error("Error:", err);
    res.render("paris", { alreadyInList: false, message: null });
  }
});

app.get("/rome", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const alreadyInList = user.wantToGoList.includes("Rome");
    res.render("rome", { alreadyInList, message: req.query.message || null });
  } catch (err) {
    console.error("Error:", err);
    res.render("rome", { alreadyInList: false, message: null });
  }
});

app.get("/bali", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const alreadyInList = user.wantToGoList.includes("Bali");
    res.render("bali", { alreadyInList, message: req.query.message || null });
  } catch (err) {
    console.error("Error:", err);
    res.render("bali", { alreadyInList: false, message: null });
  }
});

app.get("/santorini", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const alreadyInList = user.wantToGoList.includes("Santorini");
    res.render("santorini", { alreadyInList, message: req.query.message || null });
  } catch (err) {
    console.error("Error:", err);
    res.render("santorini", { alreadyInList: false, message: null });
  }
});

// --------- ADD TO WANT-TO-GO LIST ---------
app.post("/add-to-list", requireLogin, async (req, res) => {
  try {
    const { destinationName, returnUrl } = req.body;
    const username = req.session.username;

    // Find the user
    const user = await usersCollection.findOne({ username });

    // Check if destination is already in the list
    if (user.wantToGoList.includes(destinationName)) {
      return res.redirect(`${returnUrl}?message=already`);
    }

    // Add destination to the list
    await usersCollection.updateOne(
      { username },
      { $push: { wantToGoList: destinationName } }
    );

    console.log(`Added ${destinationName} to ${username}'s want-to-go list`);
    res.redirect(`${returnUrl}?message=success`);

  } catch (err) {
    console.error("Error adding to want-to-go list:", err);
    res.redirect("/home");
  }
});

// --------- WANT-TO-GO LIST PAGE ---------
app.get("/wanttogo", requireLogin, async (req, res) => {
  try {
    const user = await usersCollection.findOne({ username: req.session.username });
    const list = user.wantToGoList || [];
    
    res.render("wanttogo", { list });
  } catch (err) {
    console.error("Error loading want-to-go list:", err);
    res.render("wanttogo", { list: [] });
  }
});

// --------- REMOVE FROM WANT-TO-GO LIST ---------
app.post("/remove-from-list", requireLogin, async (req, res) => {
  try {
    const { destinationName } = req.body;
    const username = req.session.username;

    // Remove destination from the list
    await usersCollection.updateOne(
      { username },
      { $pull: { wantToGoList: destinationName } }
    );

    console.log(`Removed ${destinationName} from ${username}'s want-to-go list`);
    res.redirect("/wanttogo");

  } catch (err) {
    console.error("Error removing from want-to-go list:", err);
    res.redirect("/wanttogo");
  }
});

// --------- Search ---------
app.post("/search", requireLogin, (req, res) => {
  const queryRaw = req.body.Search || "";
  const query = queryRaw.toLowerCase().trim();

  if (!query) {
    return res.render("searchresults", { query: "", results: [] });
  }

  const results = destinations.filter((d) =>
    d.name.toLowerCase().includes(query) ||
    d.category.toLowerCase().includes(query)
  );

  res.render("searchresults", { query: queryRaw, results });
});

// Optional: if someone visits /search by URL directly (GET)
app.get("/search", requireLogin, (req, res) => {
  res.render("searchresults", { query: "", results: [] });
});

// logout
app.get("/logout", (req, res) => {
  req.session.destroy(() => {
    res.redirect("/login");
  });
});

// --------- Start server ---------
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
  console.log(`Go to http://localhost:${PORT}/register to test registration`);
});